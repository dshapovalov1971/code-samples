image: ubuntu:latest

pipelines:
  branches:
    sandbox:
    - step:
        name: Deploy CDC Resources
        script:
        # Read API Keys
        - apt-get update
        - apt-get -y install curl jq
        - replace_values () { jq -nrc --slurpfile r cdc/replacements '$r | map(select(.e=="'$BITBUCKET_BRANCH'") | "s/{{"+.n+"}}/"+.r+"/g") | join(";")'; }
        - parentSite=$(cat cdc/parentSite)
        - |
          sites=$(curl -s --fail-with-body \
              --data-urlencode userKey=$cdcAppKey \
              --data-urlencode secret=$cdcAppSecret \
              -d targetPartnerID=$cdcPartnerId \
              -d httpStatusCodes=true \
              https://admin.$cdcDC/admin.getPartnerSites | \
            jq '. as $p | .sites[] | select(.name == "'$(echo ${parentSite/"{{env}}"/$BITBUCKET_BRANCH} | jq -Rr --slurpfile dict cdc/siteNameOverrides 'INDEX($dict[]; .o) as $d | ($d[.]|.r) // . ')'").apiKey | . as $k | $p.sites | map(. | select(.apiKey == $k or .group.masterApiKey == $k))')
        - echo $sites | jq --slurpfile dict cdc/siteNameOverrides 'INDEX($dict[]; .r) as $d | . | sort_by(.groupApiKey) | map({name, apiKey, siteID}) | .[].name |= (($d[.]|.o) // .) | .[].name |= sub("'$BITBUCKET_BRANCH'"; "{{env}}")' >apikeys.json
        # Add Api Keys To Replacements
        - |
          jq -rc '.[] | .name, .apiKey, .siteID' apikeys.json |
            while IFS=$ read -r site; read -r apikey; read -r siteid; do
              echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$site-apikey\",\"r\":\"$apikey\"}" >> cdc/replacements
              echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$site-siteid\",\"r\":\"$siteid\"}" >> cdc/replacements
            done
        # Get B2B Access Token 
        - siteid=$(jq -rc '.[0] | .siteID' apikeys.json)
        - |
          b2bAccessJwt=$(curl -s --fail-with-body \
              -d partnerID=$cdcPartnerId \
              --data-urlencode userKey=$cdcAppKey \
              --data-urlencode secret=$cdcAppSecret \
              -d uid=$b2bAdminUid \
              -d httpStatusCodes=true \
              https://accounts.$cdcDC/accounts.b2b.itAdminLogin | jq -rc '.id_token')
        - b2bTenantId=$(echo $b2bAccessJwt | jq -Rrc 'split(".")[1] | @base64d | fromjson | .tenantId')
        - echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"b2b-tenant-id\",\"r\":\"$b2bTenantId\"}" >> cdc/replacements  
        - |
          b2bAccessToken=$(curl -s --fail-with-body \
              -d code=$(curl -GLs -o/dev/null --cookie noop -w "%{url_effective}" --fail-with-body \
                  -d client_id=plainid-client \
                  --data-urlencode 'redirect_uri=https://auth.us1.b2b-gigya.com/auth/realms/'$b2bTenantId'/protocol/openid-connect/auth?client_id=plainid&redirect_uri=https%3A%2F%2F'$b2bTenantId'.us1.b2b-gigya.com%2Fapp%2F&state=state&response_mode=fragment&response_type=code&scope=openid&nonce=12345&kc_idp_hint=tenant_idp' \
                  -d state=state \
                  -d response_mode=fragment \
                  -d response_type=code \
                  -d scope=openid \
                  -d nonce=12345 \
                  -d jwt=$b2bAccessJwt \
                  https://auth.us1.b2b-gigya.com/auth/realms/sysidp/protocol/openid-connect/auth |
                sed -re 's/.*[&#]code=([^&]+).*/\1/') \
              -d grant_type=authorization_code \
              -d client_id=plainid \
              --data-urlencode 'redirect_uri=https://'$b2bTenantId'.us1.b2b-gigya.com/app/' \
              https://auth.us1.b2b-gigya.com/auth/realms/$b2bTenantId/protocol/openid-connect/token |
            jq -rc '.access_token')
        # Read B2B Environment
        - |
          b2bEnvironmentId=$(curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              https://api.us1.b2b-gigya.com/env-mgmt/environment |
            jq -r '.data[] | select(.externalId == "'$siteid'").id')
        - echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"b2b-environment-id\",\"r\":\"$b2bEnvironmentId\"}" >> cdc/replacements  
        # Read B2B Authz
        - |
          b2bAuthzId=$(curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              https://api.us1.b2b-gigya.com/env-mgmt/environment/$b2bEnvironmentId/authz-ws |
            jq -r '.data[0].id')
        - echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"b2b-authz-id\",\"r\":\"$b2bAuthzId\"}" >> cdc/replacements  
        # Read B2B Partner
        - |
          b2bPartnersId=$(curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              https://api.us1.b2b-gigya.com/env-mgmt/environment/$b2bEnvironmentId/partners-ws |
            jq -r '.data[0].id')
        - echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"b2b-partners-id\",\"r\":\"$b2bPartnersId\"}" >> cdc/replacements  
        # Read B2B Schema
        - |
          b2bSchemaId=$(curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              https://api.us1.b2b-gigya.com/org-mgmt/schema/owner/$b2bPartnersId |
            jq -r '.data.schemaId')
        # Write B2B SSO Settings
        - sed -i -e "$(replace_values)" "cdc/b2b/sso.sites.json"
        - |
          curl -sX PUT --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              -H "Content-Type: application/json" \
              -d @cdc/b2b/sso.sites.json \
              https://api.us1.b2b-gigya.com/env-mgmt/environment/$b2bEnvironmentId/federation/jit-sso-sites
        # Write B2B Organization Attributes
        - |
          jq -rc '.[] | ., .key' "cdc/b2b/organization.attributes.json" |
            while IFS=$ read -r json; read -r key; do
              curl -sX PUT --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  -H "Content-Type: application/json" \
                  -d "$json" \
                  https://api.us1.b2b-gigya.com/org-mgmt/schema/$b2bSchemaId/attribute/$key
              echo
            done
        # Write B2B Assets
        - |
          b2bAssetTypes="$(curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              -d filter%5BownerId%5D=$b2bAuthzId \
              https://api.us1.b2b-gigya.com/internal-assets/asset-type/search |
            jq '.data | map({name, id})')"
        - |
          jq -rc '.[] | ., .name' cdc/b2b/assets/types.json |
            sed -e "$(replace_values)" | while IFS=$ read -r json; read -r name; do
              b2bAssetTypeId="$(echo "$b2bAssetTypes" | jq -rc --arg name "$name" 'map(select(.name == $name)) | if length > 0 then .[0].id else "'$(curl -s --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  -H "Content-Type: application/json" \
                  -d "{\"name\": \"$name\", \"ownerId\": \"$b2bAuthzId\"}" \
                  https://api.us1.b2b-gigya.com/internal-assets/asset-type | jq -rc '.data.id')'" end')"
              curl -sX PUT --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  -H "Content-Type: application/json" \
                  -d "$(echo $json | jq -rc --arg id $b2bAssetTypeId '.id |= $id')" \
                  https://api.us1.b2b-gigya.com/internal-assets/asset-type/$b2bAssetTypeId                  
              echo
            echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$name-b2b-asset-type-id\",\"r\":\"$b2bAssetTypeId\"}" >> cdc/replacements  
            b2bAssetActions="$(curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  https://api.us1.b2b-gigya.com/internal-assets/asset-type/$b2bAssetTypeId/action/search |
                jq '.data | map({name, id})')"
              jq -rc '.[] | ., .name' "cdc/b2b/assets/$name/actions.json"  |
                while IFS=$ read -r json; read -r action; do
                  b2bAssetActionId="$(echo "$b2bAssetActions" | jq -rc --arg name "$action" 'map(select(.name == $name)) | if length > 0 then .[0].id else "'$(curl -s --fail-with-body \
                      -H "Authorization: Bearer $b2bAccessToken" \
                      -H "Content-Type: application/json" \
                      -d "{\"name\": \"$action\"}" \
                      https://api.us1.b2b-gigya.com/internal-assets/asset-type/$b2bAssetTypeId/action | jq -rc '.data.id')'" end')"
                  curl -sX PUT --fail-with-body \
                      -H "Authorization: Bearer $b2bAccessToken" \
                      -H "Content-Type: application/json" \
                      -d "$(echo $json | jq -rc --arg id $b2bAssetActionId 'del(.assetSchemaId) | .id |= $id')" \
                      https://api.us1.b2b-gigya.com/internal-assets/asset-type/$b2bAssetTypeId/action/$b2bAssetActionId
                  echo
                  echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$name|$action-b2b-asset-action-id\",\"r\":\"$b2bAssetActionId\"}" >> cdc/replacements
                done
              b2bAssetRulesets="$(curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                   https://api.us1.b2b-gigya.com/internal-assets/4.0/asset-types/$b2bAssetTypeId/rulesets |
                jq '.data | map({name, id})')"
              jq -rc '.[] | ., .name' "cdc/b2b/assets/$name/rulesets.json"  |
                while IFS=$ read -r json; read -r ruleset; do
                  b2bAssetRulesetId="$(echo "$b2bAssetRulesets" | jq -rc --arg name "$ruleset" 'map(select(.name == $name)) | if length > 0 then .[0].id else "'$(curl -s --fail-with-body \
                      -H "Authorization: Bearer $b2bAccessToken" \
                      -H "Content-Type: application/json" \
                      -d "{\"name\": \"$ruleset\"}" \
                      https://api.us1.b2b-gigya.com/internal-assets/4.0/asset-types/$b2bAssetTypeId/rulesets | jq -rc '.data.id')'" end')"
                  if [ "$ruleset" != "All Assets" ]; then
                    curl -sX PUT --fail-with-body \
                        -H "Authorization: Bearer $b2bAccessToken" \
                        -H "Content-Type: application/json" \
                        -d "$(echo $json | jq -rc --arg id $b2bAssetRulesetId 'del(.assetSchemaId) | .id |= $id')" \
                        https://api.us1.b2b-gigya.com/internal-assets/4.0/asset-types/$b2bAssetTypeId/rulesets/$b2bAssetRulesetId
                    echo
                  fi
                  echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$name|$ruleset-b2b-asset-ruleset-id\",\"r\":\"$b2bAssetRulesetId\"}" >> cdc/replacements
                done
              b2bAssets="$(curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  https://api.us1.b2b-gigya.com/internal-assets/asset-type/$b2bAssetTypeId/asset/search |
                jq '.data | map({name, id})')"
              jq -rc '.[] | ., .name' "cdc/b2b/assets/$name/assets.json"  |
                while IFS=$ read -r json; read -r asset; do
                  b2bAssetId="$(echo "$b2bAssets" | jq -rc --arg name "$asset" 'map(select(.name == $name)) | if length > 0 then .[0].id else "'$(curl -s --fail-with-body \
                      -H "Authorization: Bearer $b2bAccessToken" \
                      -H "Content-Type: application/json" \
                      -d "{\"name\": \"$asset\", \"attributes\": {\"path\": [\"$asset\"]}}" \
                      https://api.us1.b2b-gigya.com/internal-assets/asset-type/$b2bAssetTypeId/asset | jq -rc '.data.id')'" end')"
                  curl -sX PUT --fail-with-body \
                      -H "Authorization: Bearer $b2bAccessToken" \
                      -H "Content-Type: application/json" \
                      -d "$(echo $json | jq -rc --arg id $b2bAssetId 'del(.assetSchemaId) | .id |= $id')" \
                      https://api.us1.b2b-gigya.com/internal-assets/asset-type/$b2bAssetTypeId/asset/$b2bAssetId
                  echo
                  echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$name|$asset-b2b-asset-id\",\"r\":\"$b2bAssetId\"}" >> cdc/replacements
                done
            done
        # Write B2B Policies
        - |
          b2bPolicies="$(curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              -d filter%5BownerId%5D=$b2bAuthzId \
              https://api.us1.b2b-gigya.com/policy-mgmt/policy/list |
            jq '.data | map({name, id})')"
        - |
          jq -rc '.[] | ., .name' cdc/b2b/policies/list.json |
            sed -e "$(replace_values)" | while IFS=$ read -r json; read -r name; do
              if [ "$name" != "Delegated Admin" ]; then
                b2bPolicyId="$(echo "$b2bPolicies" | jq -rc --arg name "$name" 'map(select(.name == $name)) | if length > 0 then .[0].id else "'$(curl -s --fail-with-body \
                    -H "Authorization: Bearer $b2bAccessToken" \
                    -H "Content-Type: application/json" \
                    -d "{\"name\": \"$name\", \"authWsId\": \"$b2bAuthzId\"}" \
                    https://api.us1.b2b-gigya.com/policy-mgmt/policy | jq -rc '.data.id')'" end')"
                curl -sX PUT --fail-with-body \
                    -H "Authorization: Bearer $b2bAccessToken" \
                    -H "Content-Type: application/json" \
                    -d "$(echo $json | jq -rc --arg id $b2bPolicyId '.externalId |= $id | .id |= $id')" \
                    https://api.us1.b2b-gigya.com/policy-mgmt/policy/$b2bPolicyId      
                echo
                sed -i -e  "$(replace_values)" "cdc/b2b/policies/$name/asset.types.json" 
                curl -sX PUT --fail-with-body \
                    -H "Authorization: Bearer $b2bAccessToken" \
                    -H "Content-Type: application/json" \
                    -d "@cdc/b2b/policies/$name/asset.types.json" \
                    https://api.us1.b2b-gigya.com/policy-mgmt/policy/$b2bPolicyId/asset-types
                echo
                sed -i -e  "$(replace_values)" "cdc/b2b/policies/$name/availability.json" 
                curl -sX PUT --fail-with-body \
                    -H "Authorization: Bearer $b2bAccessToken" \
                    -H "Content-Type: application/json" \
                    -d "@cdc/b2b/policies/$name/availability.json" \
                    https://api.us1.b2b-gigya.com/policy-mgmt/policy/$b2bPolicyId/availability
                echo
              fi
            done
        # Write B2B Applications
        - |
          b2bApplications="$(curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              -d filter%5BownerId%5D=$b2bAuthzId \
              https://api.us1.b2b-gigya.com/internal-assets/4.0/applications |
            jq '.data | map({id, schema, name: .attributes.name[0]})')"
        - |
          jq -rc '.[] | ., .attributes.name[0], .attributes.color[0]' cdc/b2b/applications/list.json |
            sed -e "$(replace_values)" | while IFS=$ read -r json; read -r name; read -r color; do
              if [ "$name" != "Delegated Admin" ]; then
                b2bApplicationId="$(echo "$b2bApplications" | jq -rc --arg name "$name" 'map(select(.name == $name)) | if length > 0 then .[0].id else "'$(curl -s --fail-with-body \
                    -H "Authorization: Bearer $b2bAccessToken" \
                    -H "Content-Type: application/json" \
                    -d "{\"attributes\": {\"name\": [\"$name\"], \"color\": [\"$color\"]}, \"ownerId\": \"$b2bAuthzId\", \"schema\": \"$(echo "$b2bApplications" | jq -rc '.[0].schema')\"}" \
                    https://api.us1.b2b-gigya.com/internal-assets/applications/v3 | jq -rc '.data.id')'" end')"
                curl -sX PUT --fail-with-body \
                    -H "Authorization: Bearer $b2bAccessToken" \
                    -H "Content-Type: application/json" \
                    -d "$(echo $json | jq -rc --arg id $b2bApplicationId '.externalId |= $id | .id |= $id')" \
                    https://api.us1.b2b-gigya.com/internal-assets/applications/v3/$b2bApplicationId
                echo
                sed -i -e  "$(replace_values)" "cdc/b2b/applications/$name/asset.types.json" 
                curl -sX PUT --fail-with-body \
                    -H "Authorization: Bearer $b2bAccessToken" \
                    -H "Content-Type: application/json" \
                    -d "$(jq -rc '{assetTypeIds: map(.id)}' "cdc/b2b/applications/$name/asset.types.json")" \
                    https://api.us1.b2b-gigya.com/internal-assets/applications/v3/$b2bApplicationId/asset-types
                echo
                echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$name-b2b-app-client-id\",\"r\":\"$(curl -Gs --fail-with-body \
                    -H "Authorization: Bearer $b2bAccessToken" \
                    https://api.us1.b2b-gigya.com/internal-assets/scopes/v3/$b2bApplicationId | jq -rc '.data[0].clientId')\"}" >> cdc/replacements
              fi
            done
        # Write Site Configurations
        - |
          jq -rc '.[] | .name, .apiKey' apikeys.json |
            while IFS=$ read -r site; read -r apikey; do
              curl -s --fail-with-body \
                  -d apiKey=$apikey \
                  --data-urlencode userKey=$cdcAppKey \
                  --data-urlencode secret=$cdcAppSecret \
                  $(echo $sites | jq -rc --arg rtu "$(jq -rc '.[] | select(.name == "'$site'") | .validDomains.login | map(. | select(.|test("^(\\*\\.)?[^.]*\\.[^.]*\\/\\*$"))) | if length > 0 then (tostring | "-d '\''trustedSiteURLs="+.+"'\''") else "" end' cdc/sites.json)" '.[] | select(.apiKey == "'$apikey'") | . as $p | if (.validDomains.login | length) == 2 and (.validDomains.login | index($p.name+"/*")) and (.validDomains.login | index("*."+$p.name+"/*")) then $rtu else "" end') \
                  "$(jq -rc '.[] | select(.name == "'$site'") | .cnames.apiDomainPrefix | if . then "-d gigyaSettings={\"enableSSLForCNAME\": true, \"customAPIDomainPrefix\": \""+.+"\"}" else "" end' cdc/sites.json | sed -e 's/ //')" \
                  $(echo $sites | jq -rc --arg rtu "$(jq -rc '.[] | select(.name == "'$site'") | .recaptchaV2 | if .siteKey then "-d recaptchaV2={\"secret\": \""+.secret+"\", \"siteKey\": \""+.siteKey+"\"}" else "" end' cdc/sites.json)" '.[] | select(.apiKey == "'$apikey'") | . as $p | if .recaptchaV2.siteKey then "" else $rtu end') \
                  "$(jq -rc '.[] | select(.name == "'$site'") | .globalConf | if . then . else "" end  | if . then "-d globalConf="+. else "" end' cdc/sites.json | sed -e "$(replace_values)" | perl -0777pe 's/ //')" \
                  -d httpStatusCodes=true \
                  https://admin.$cdcDC/admin.setSiteConfig         
            done        
        # Write Schemas
        - parent=true
        - |
          jq -rc '.[] | .name, .apiKey' apikeys.json |
            while IFS=$ read -r site; read -r apikey; do
              curl -s --fail-with-body \
                  -d apiKey=$apikey \
                  --data-urlencode userKey=$cdcAppKey \
                  --data-urlencode secret=$cdcAppSecret \
                  "$(jq -nrc --arg p $parent 'if $p=="false" then "-d scope=site" else "" end' | sed -e 's/ //')" \
                  $(find "cdc/$site/schema" -type f | while read -r file; do bn=$(basename -s .json $file); echo "--data-urlencode $bn=$(jq -rc --arg file $bn --arg p $parent '. | if $file!="dataSchema" then del(.dynamicSchema) else . end | .fields |= with_entries(if $file=="profileSchema" then (select(.key | startswith("oidcData.") or startswith("samlData.") | not) | .value |= if $p=="true" then {writeAccess, required} else {required} end) else (if $file=="dataSchema" then (.value |= if $p=="true" then . else {required} end) else . end) end)' $file)"; done) \
                  -d httpStatusCodes=true \
                  https://accounts.$cdcDC/accounts.setSchema 
              parent=false
            done        
        # Write Consent Statements
        - parent=true
        - |
          jq -rc '.[] | .name, .apiKey' apikeys.json |
            while IFS=$ read -r site; read -r apikey; do
              if [ -d cdc/$site ]; then
                [ "$parent" == "false" ] && jq 'with_entries(.value |= {isActive})' cdc/$site/consent.statements.json > cdc/$site/consent.statements.json.tmp && mv cdc/$site/consent.statements.json.tmp cdc/$site/consent.statements.json
                curl -s --fail-with-body \
                    -d apiKey=$apikey \
                    --data-urlencode userKey=$cdcAppKey \
                    --data-urlencode secret=$cdcAppSecret \
                    --data-urlencode preferences@cdc/$site/consent.statements.json \
                    -d httpStatusCodes=true \
                    https://accounts.$cdcDC/accounts.setConsentsStatements
              fi
              parent=false
            done        
        # Write Policies
        - parent=true
        - |
          jq -rc '.[] | .name, .apiKey' apikeys.json |
            while IFS=$ read -r site; read -r apikey; do
              if [ -d cdc/$site ]; then
                rm -f cdc/$site/policies/rba.json
                [ "$parent" == "false"  ] && rm -f cdc/$site/policies/authentication.json
                [ "$parent" == "false"  ] && rm -f cdc/$site/policies/passwordComplexity.json
                [ "$parent" == "false"  ] && rm -f cdc/$site/policies/profilePhoto.json
                [ "$parent" == "false"  ] && rm -f cdc/$site/policies/federation.json
                [ "$parent" == "false" -a -f cdc/$site/policies/registration.json ] && jq 'del(.requireSecurityQuestion, .requireLoginID, .enforceCoppa)' cdc/$site/policies/registration.json > cdc/$site/policies/registration.json.tmp && mv cdc/$site/policies/registration.json.tmp cdc/$site/policies/registration.json
                [ "$parent" == "false" -a -f cdc/$site/policies/accountOptions.json ] && jq 'del(.allowUnverifiedLogin, .preventLoginIDHarvesting, .defaultLanguage, .loginIdentifiers, .loginIdentifierConflict)' cdc/$site/policies/accountOptions.json > cdc/$site/policies/accountOptions.json.tmp && mv cdc/$site/policies/accountOptions.json.tmp cdc/$site/policies/accountOptions.json
                [ "$parent" == "true" -a -f cdc/$site/policies/security.json ] && jq 'del(.accountLockout, .captcha, .ipLockout)' cdc/$site/policies/security.json > cdc/$site/policies/security.json.tmp && mv cdc/$site/policies/security.json.tmp cdc/$site/policies/security.json
                [ "$parent" == "false" -a -f cdc/$site/policies/security.json ] && jq 'del(.accountLockout, .captcha, .ipLockout, .passwordChangeInterval, .passwordHistorySize)' cdc/$site/policies/security.json > cdc/$site/policies/security.json.tmp && mv cdc/$site/policies/security.json.tmp cdc/$site/policies/security.json
                [ "$parent" == "false" -a -f cdc/$site/policies/twoFactorAuth.json ] && jq 'del(.providers)' cdc/$site/policies/twoFactorAuth.json > cdc/$site/policies/twoFactorAuth.json.tmp && mv cdc/$site/policies/twoFactorAuth.json.tmp cdc/$site/policies/twoFactorAuth.json
                curl -s --fail-with-body \
                    -d apiKey=$apikey \
                    --data-urlencode userKey=$cdcAppKey \
                    --data-urlencode secret=$cdcAppSecret \
                    $(find "cdc/$site/policies" -type f | while read -r file; do bn=$(basename -s .json $file); sed -i -e "$(replace_values)" $file; echo "--data-urlencode $bn@$file"; done) \
                    -d httpStatusCodes=true \
                    https://accounts.$cdcDC/accounts.setPolicies 
              fi
              parent=false
            done        
        # Write ScreenSets
        - |
          jq -rc '.[] | .name, .apiKey' apikeys.json |
            while IFS=$ read -r site; read -r apikey; do
              jq -rc '.[] | del(.rawTranslations, .compressionType) ' cdc/$site/screenSets.json |
                while IFS=$ read -r ss; do
                  curl -s --fail-with-body \
                      -d apiKey=$apikey \
                      --data-urlencode userKey=$cdcAppKey \
                      --data-urlencode secret=$cdcAppSecret \
                      $(echo "$ss" | jq -rc '. | to_entries[] | .key, (.value | @base64)' | while IFS=$ read -r key; read -r value; do echo $value | base64 -d > $key; [ $(stat -c %s $key) -gt 0 ] && echo "--data-urlencode $key@$key"; done) \
                      -d httpStatusCodes=true \
                      https://accounts.$cdcDC/accounts.setScreenSet 
                done
            done        
        # Write RBA Policy
        - apikey=$(jq -rc '.[0] | .apiKey' apikeys.json)
        - |
          curl -s \
              -d apiKey=$apikey \
              --data-urlencode userKey=$cdcAppKey \
              --data-urlencode secret=$cdcAppSecret \
              --data-urlencode policy@cdc/rba.policy.json \
              -d httpStatusCodes=true \
              https://accounts.$cdcDC/accounts.rba.setPolicy
        # Write IDX Variables
        - |
          jq -rc '.[] | .name, .apiKey' apikeys.json |
            while IFS=$ read -r site; read -r apikey; do
              vars="$(curl -s --fail-with-body \
                  -d apiKey=$apikey \
                  --data-urlencode userKey=$cdcAppKey \
                  --data-urlencode secret=$cdcAppSecret \
                  -d scope=all \
                  -d httpStatusCodes=true \
                  https://idx.$cdcDC/idx.getGlobalVariables |
                jq '.data | map(.name)')"
              jq -rc '.[] | del(.lastUpdated, .created) ' cdc/$site/dataflows/globalVariables.json |
                sed -e "$(replace_values)" | while IFS=$ read -r ss; do
                  if [ "$(echo "$vars" | jq -rc --arg name "$(echo "$ss" | jq -rc '.name')" 'map(select(. == $name)) | if length > 0 then "set" else "create" end')" == "create" ]; then
                    curl -s --fail-with-body \
                        -d apiKey=$apikey \
                        --data-urlencode userKey=$cdcAppKey \
                        --data-urlencode secret=$cdcAppSecret \
                        $(echo "$ss" | jq -rc '. | to_entries[] | .key, (.value | @uri)' | while IFS=$ read -r key; read -r value; do echo "-d $key=$value"; done) \
                        -d httpStatusCodes=true \
                        https://idx.$cdcDC/idx.createGlobalVariable 
                  fi            
                done
            done        
        # Write IDX Dataflows
        - |
          jq -rc '.[] | .name, .apiKey' apikeys.json |
            while IFS=$ read -r site; read -r apikey; do
              dataflows="$(curl -s --fail-with-body \
                  -d apiKey=$apikey \
                  --data-urlencode userKey=$cdcAppKey \
                  --data-urlencode secret=$cdcAppSecret \
                  -d query='select * from dataflow' \
                  -d httpStatusCodes=true \
                  https://idx.$cdcDC/idx.search |
                jq '.result // [] | map({name, id})')"
              jq -rc '.[] | del(.apiKey, .siteId)' cdc/$site/dataflows/dataflows.json |
                while IFS=$ read -r ss; do
                  dfname=$(echo "$ss" | jq -rc '.name')
                  op=$(echo "$dataflows" | jq -rc --arg name "$dfname" 'map(select(.name == $name)) | if length > 0 then "set" else "create" end')
                  resp=$(curl -s --fail-with-body \
                      -d apiKey=$apikey \
                      --data-urlencode userKey=$cdcAppKey \
                      --data-urlencode secret=$cdcAppSecret \
                      --data-urlencode data="$(echo "$ss" | jq -rc --arg id $(echo "$dataflows" | jq -rc --arg name "$dfname" 'map(select(.name == $name)) | if length>0 then .[0].id else "noop" end') 'if $id != "noop" then (.id=$id) else del(.id) end')" \
                      -d httpStatusCodes=false \
                      https://idx.$cdcDC/idx."$op"Dataflow)
                  echo "$resp" | jq '.'
                  [[ "$(echo $resp | jq -rc '.errorCode')" =~ ^(0|403200)$ ]] || exit 22
                  if [ "$op" == "create" ]; then dataflows=$(echo "$dataflows" | jq --arg name "$dfname" --arg id "$(echo "$resp" | jq -rc '.id')" '.+=[{"id":$id,"name":$name}]'); fi
                done
          # Write IDX Scheduling
              schedules="$(curl -s --fail-with-body \
                  -d apiKey=$apikey \
                  --data-urlencode userKey=$cdcAppKey \
                  --data-urlencode secret=$cdcAppSecret \
                  -d query='select * from scheduling' \
                  -d httpStatusCodes=true \
                  https://idx.$cdcDC/idx.search |              
                jq '.result // [] | map({name, id, dataflowName})')"
              jq -rc '.[] | del(.apiKey, .siteId)' cdc/$site/dataflows/scheduling.json |
                sed -e "$(replace_values)" | while IFS=$ read -r ss; do
                  curl -s --fail-with-body \
                      -d apiKey=$apikey \
                      --data-urlencode userKey=$cdcAppKey \
                      --data-urlencode secret=$cdcAppSecret \
                      --data-urlencode data="$(echo "$ss" | jq -rc --arg dataflowId "$(echo "$dataflows" | jq -rc --arg dataflowName "$(echo "$ss" | jq -rc '.dataflowName')" 'map(select(.name == $dataflowName))[0].id')" --arg id $(echo "$schedules" | jq -rc --arg name "$(echo "$ss" | jq -rc '.name')" 'map(select(.name == $name)) | if length>0 then .[0].id else "noop" end') 'if $id != "noop" then (.id=$id) else del(.id) end | .dataflowId=$dataflowId')" \
                      -d httpStatusCodes=true \
                      https://idx.$cdcDC/idx.$(echo "$schedules" | jq -rc --argjson df "$(echo "$ss" | jq -rc '{name, dataflowName}')" 'map(select(.name == $df.name and .dataflowName == $df.dataflowName)) | if length > 0 then "set" else "create" end')Scheduling
                done
            done                      
        # Write Communication Channels
        - apikey=$(jq -rc '.[0] | .apiKey' apikeys.json)
        - |
          curl -s --fail-with-body \
              -d apiKey=$apikey \
              --data-urlencode userKey=$cdcAppKey \
              --data-urlencode secret=$cdcAppSecret \
              --data-urlencode Channels@cdc/communication.channels.json \
              -d httpStatusCodes=true \
              https://accounts.$cdcDC/accounts.communication.setChannels
        # Write Communication Topic Settings
        - parent=true
        - |
          jq -rc '.[] | .name, .apiKey' apikeys.json |
            while IFS=$ read -r site; read -r apikey; do
              if [ -d cdc/$site ]; then
                [ "$parent" == "true" ] && jq 'with_entries(.value |= del(.lastModified, .dependsOn))' cdc/$site/communication/topicSettings.json > cdc/$site/communication/topicSettings.json.tmp && mv cdc/$site/communication/topicSettings.json.tmp cdc/$site/communication/topicSettings.json
                [ "$parent" == "false" ] && jq 'with_entries(.value |= {isActive})' cdc/$site/communication/topicSettings.json > cdc/$site/communication/topicSettings.json.tmp && mv cdc/$site/communication/topicSettings.json.tmp cdc/$site/communication/topicSettings.json
                curl -s --fail-with-body \
                    -d apiKey=$apikey \
                    --data-urlencode userKey=$cdcAppKey \
                    --data-urlencode secret=$cdcAppSecret \
                    --data-urlencode CommunicationSettings@cdc/$site/communication/topicSettings.json \
                    -d httpStatusCodes=true \
                    https://accounts.$cdcDC/accounts.communication.setTopicSettings
              fi
              parent=false
            done        
        # Write SAML IdP Configuration
        - |
          jq -rc '.[] | .name, .apiKey' apikeys.json |
            while IFS=$ read -r site; read -r apikey; do
              jq -rc '{proxyPageURL, errorPageURL}' cdc/$site/federation/samlIdPConfiguration.json |
                sed -e "$(replace_values)" | while IFS=$ read -r ss; do
                  curl -s --fail-with-body \
                      -d apiKey=$apikey \
                      --data-urlencode userKey=$cdcAppKey \
                      --data-urlencode secret=$cdcAppSecret \
                      -d config=$(echo "$ss" | jq -rc '@uri') \
                      -d httpStatusCodes=true \
                      https://fidm.$cdcDC/fidm.saml.idp.setConfig
                done
            done        
        # Write SAML SPs
        - |
          jq -rc '.[] | .name, .apiKey' apikeys.json |
            while IFS=$ read -r site; read -r apikey; do
              sps="$(curl -s --fail-with-body \
                  -d apiKey=$apikey \
                  --data-urlencode userKey=$cdcAppKey \
                  --data-urlencode secret=$cdcAppSecret \
                  -d httpStatusCodes=true \
                  https://fidm.$cdcDC/fidm.saml.idp.getRegisteredSPs |
                jq '.configs | map(.name)')"
              jq -rc '.[] | del(.certificateId) | .idpSigningAlgorithm |= "SHA256"' cdc/$site/federation/samlSPs.json |
                sed -e "$(replace_values)" | while IFS=$ read -r ss; do
                  if [ "$(echo "$sps" | jq -rc --arg name "$(echo "$ss" | jq -rc '.name')" 'map(select(. == $name)) | if length > 0 then "set" else "create" end')" == "create" ]; then
                    curl -s --fail-with-body \
                        -d apiKey=$apikey \
                        --data-urlencode userKey=$cdcAppKey \
                        --data-urlencode secret=$cdcAppSecret \
                        -d config=$(echo "$ss" | jq -rc '@uri') \
                        -d httpStatusCodes=true \
                        https://fidm.$cdcDC/fidm.saml.idp.registerSP
                  fi            
                done
            done        
        # Write SAML IdPs
        - |
          jq -rc '.[] | .name, .apiKey' apikeys.json |
            while IFS=$ read -r site; read -r apikey; do
              idps="$(curl -s --fail-with-body \
                  -d apiKey=$apikey \
                  --data-urlencode userKey=$cdcAppKey \
                  --data-urlencode secret=$cdcAppSecret \
                  -d httpStatusCodes=true \
                  https://fidm.$cdcDC/fidm.saml.getRegisteredIdPs |
                jq '.configs | map(.name)')"
              jq -rc '.[] | del(.certificateId) | .spSigningAlgorithm |= "SHA256"' cdc/$site/federation/samlIdPs.json |
                sed -e "$(replace_values)" | while IFS=$ read -r ss; do
                  if [ "$(echo "$idps" | jq -rc --arg name "$(echo "$ss" | jq -rc '.name')" 'map(select(. == $name)) | if length > 0 then "set" else "create" end')" == "create" ]; then
                    curl -s --fail-with-body \
                        -d apiKey=$apikey \
                        --data-urlencode userKey=$cdcAppKey \
                        --data-urlencode secret=$cdcAppSecret \
                        -d config=$(echo "$ss" | jq -rc '@uri') \
                        -d httpStatusCodes=true \
                        https://fidm.$cdcDC/fidm.saml.registerIdP
                  fi            
                done
            done        

  custom:
    refresh-cdc-configuration:
    - step:
        name: Read CDC Configuration
        script:
        - apt-get update
        - apt-get -y install curl jq git
        - parentSite=$(cat cdc/parentSite)
        - replace_values () { jq -nrc --slurpfile r cdc/replacements '$r | map(select(.e=="'$BITBUCKET_BRANCH'") | "s/"+.r+"/{{"+.n+"}}/g") | join(";")'; }
        - mkdir -p cdc
        - cp cdc/replacements cdc/replacements.bak
        # Read Sites
        - |
          curl -s --fail-with-body \
              --data-urlencode userKey=$cdcAppKey \
              --data-urlencode secret=$cdcAppSecret \
              -d targetPartnerID=$cdcPartnerId \
              -d httpStatusCodes=true \
              https://admin.$cdcDC/admin.getPartnerSites |
            jq --slurpfile dict cdc/siteNameOverrides 'INDEX($dict[]; .r) as $d | . as $p | .sites[] | select(.name == "'$(echo ${parentSite/"{{env}}"/$BITBUCKET_BRANCH} | jq -Rr --slurpfile dict cdc/siteNameOverrides 'INDEX($dict[]; .o) as $d | ($d[.]|.r) // . ')'").apiKey | . as $k | $p.sites | map(select(.apiKey == $k or .group.masterApiKey == $k)) | .[].name |= (($d[.]|.o) // .) | .[].name |= sub("'$BITBUCKET_BRANCH'"; "{{env}}")' |
            sed -e "$(replace_values)" > cdc/sites.json
        - readarray -d " " -t asite < <(printf '%s' "$(jq -rc '. | sort_by(.groupApiKey) | map(.name) | join(" ")' cdc/sites.json)")
        - readarray -d " " -t asiteid < <(printf '%s' "$(jq -rc '. | sort_by(.groupApiKey) | map(.siteID) | join(" ")' cdc/sites.json)")
        - readarray -d " " -t aapikey < <(printf '%s' "$(jq -rc '. | sort_by(.groupApiKey) | map(.apiKey) | join(" ")' cdc/sites.json)")
        - commonProperties='.callId, .errorCode, .apiVersion, .statusCode, .statusReason, .time'
        # Add Api Keys To Replacements
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            siteid="${asiteid[$i]}"
            apikey="${aapikey[$i]}"
            echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$site-apikey\",\"r\":\"$apikey\"}" >> cdc/replacements
            echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$site-siteid\",\"r\":\"$siteid\"}" >> cdc/replacements
          done        
        # Read B2B Sites Info
        - mkdir -p cdc/b2b
        - apikey="${aapikey[0]}"
        - |
          curl -Gs --fail-with-body \
              -d apiKey=$apikey \
              --data-urlencode userKey=$cdcAppKey \
              --data-urlencode secret=$cdcAppSecret \
              -d httpStatusCodes=true \
              https://accounts.$cdcDC/accounts.b2b.getPartnerSitesInfo |
            jq --slurpfile dict cdc/siteNameOverrides 'INDEX($dict[]; .r) as $d | .SitesInfo | map(select(.SiteName == "'$(echo ${parentSite/"{{env}}"/$BITBUCKET_BRANCH} | jq -Rr --slurpfile dict cdc/siteNameOverrides 'INDEX($dict[]; .o) as $d | ($d[.]|.r) // . ')'")) | .[].SiteName |= (($d[.]|.o) // .) | .[].SiteName |= sub("'$BITBUCKET_BRANCH'"; "{{env}}")' |
            sed -e "$(replace_values)" > "cdc/b2b/sites.info.json"
        # Get B2B Access Token 
        - |
          b2bAccessJwt=$(curl -s --fail-with-body \
              -d partnerID=$cdcPartnerId \
              --data-urlencode userKey=$cdcAppKey \
              --data-urlencode secret=$cdcAppSecret \
              -d uid=$b2bAdminUid \
              -d httpStatusCodes=true \
              https://accounts.$cdcDC/accounts.b2b.itAdminLogin | jq -rc '.id_token')
        - b2bTenantId=$(echo $b2bAccessJwt | jq -Rrc 'split(".")[1] | @base64d | fromjson | .tenantId')
        - echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"b2b-tenant-id\",\"r\":\"$b2bTenantId\"}" >> cdc/replacements  
        - |
          b2bAccessToken=$(curl -s --fail-with-body \
              -d code=$(curl -GLs -o/dev/null --cookie noop -w "%{url_effective}" --fail-with-body \
                  -d client_id=plainid-client \
                  --data-urlencode 'redirect_uri=https://auth.us1.b2b-gigya.com/auth/realms/'$b2bTenantId'/protocol/openid-connect/auth?client_id=plainid&redirect_uri=https%3A%2F%2F'$b2bTenantId'.us1.b2b-gigya.com%2Fapp%2F&state=state&response_mode=fragment&response_type=code&scope=openid&nonce=12345&kc_idp_hint=tenant_idp' \
                  -d state=state \
                  -d response_mode=fragment \
                  -d response_type=code \
                  -d scope=openid \
                  -d nonce=12345 \
                  -d jwt=$b2bAccessJwt \
                  https://auth.us1.b2b-gigya.com/auth/realms/sysidp/protocol/openid-connect/auth |
                sed -re 's/.*[&#]code=([^&]+).*/\1/') \
              -d grant_type=authorization_code \
              -d client_id=plainid \
              --data-urlencode 'redirect_uri=https://'$b2bTenantId'.us1.b2b-gigya.com/app/' \
              https://auth.us1.b2b-gigya.com/auth/realms/$b2bTenantId/protocol/openid-connect/token |
            jq -rc '.access_token')
        # Read B2B Environment
        - |
          b2bEnvironmentId=$(curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              https://api.us1.b2b-gigya.com/env-mgmt/environment |
            jq -r '.data[] | select(.externalId == "'${asiteid[0]}'").id')
        - echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"b2b-environment-id\",\"r\":\"$b2bEnvironmentId\"}" >> cdc/replacements  
        # Read B2B Authz
        - |
          b2bAuthzId=$(curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              https://api.us1.b2b-gigya.com/env-mgmt/environment/$b2bEnvironmentId/authz-ws |
            jq -r '.data[0].id')
        - echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"b2b-authz-id\",\"r\":\"$b2bAuthzId\"}" >> cdc/replacements  
        # Read B2B Partner
        - |
          b2bPartnersId=$(curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              https://api.us1.b2b-gigya.com/env-mgmt/environment/$b2bEnvironmentId/partners-ws |
            jq -r '.data[0].id')
        - echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"b2b-partners-id\",\"r\":\"$b2bPartnersId\"}" >> cdc/replacements  
        # Read B2B SSO Settings
        - |
          curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              https://api.us1.b2b-gigya.com/env-mgmt/environment/$b2bEnvironmentId/federation/jit-sso-sites |
            sed -e "$(replace_values)" | jq '.data' > "cdc/b2b/sso.sites.json"              
        # Read B2B Organization Attributes
        - |
          curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              https://api.us1.b2b-gigya.com/org-mgmt/schema/owner/$b2bPartnersId |
            jq '.data.attributes' > "cdc/b2b/organization.attributes.json"
        # Read B2B Member Attributes
        - |
          curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              https://api.us1.b2b-gigya.com/env-mgmt/partners-ws/$b2bPartnersId/identity-templates |
            jq '.data[0].attributes' > "cdc/b2b/member.attributes.json"
        # Read B2B Assets
        - mkdir -p cdc/b2b/assets
        - |
          curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              -d filter%5BownerId%5D=$b2bAuthzId \
              https://api.us1.b2b-gigya.com/internal-assets/asset-type/search |
            sed -e "$(replace_values)" | jq '.data' > cdc/b2b/assets/types.json
        - |
          jq -rc '.[] | .id, .name' cdc/b2b/assets/types.json |
            while IFS=$ read -r id; read -r name; do
              echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$name-b2b-asset-type-id\",\"r\":\"$id\"}" >> cdc/replacements  
              mkdir -p "cdc/b2b/assets/$name"
              curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  https://api.us1.b2b-gigya.com/internal-assets/asset-type/$id/action/search |
                sed -e "$(replace_values)" | jq '.data' > "cdc/b2b/assets/$name/actions.json"              
              jq -rc '.[] | .id, .name' "cdc/b2b/assets/$name/actions.json"  |
                while IFS=$ read -r id; read -r action; do
                  echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$name|$action-b2b-asset-action-id\",\"r\":\"$id\"}" >> cdc/replacements
                done
              curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  https://api.us1.b2b-gigya.com/internal-assets/4.0/asset-types/$id/rulesets |
                sed -e "$(replace_values)" | jq '.data' > "cdc/b2b/assets/$name/rulesets.json"              
              jq -rc '.[] | .id, .name' "cdc/b2b/assets/$name/rulesets.json"  |
                while IFS=$ read -r id; read -r ruleset; do
                  echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$name|$ruleset-b2b-asset-ruleset-id\",\"r\":\"$id\"}" >> cdc/replacements
                done
              curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  https://api.us1.b2b-gigya.com/internal-assets/asset-type/$id/asset/search |
                sed -e "$(replace_values)" | jq '.data' > "cdc/b2b/assets/$name/assets.json"              
              jq -rc '.[] | .id, .name' "cdc/b2b/assets/$name/assets.json"  |
                while IFS=$ read -r id; read -r asset; do
                  echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$name|$asset-b2b-asset-id\",\"r\":\"$id\"}" >> cdc/replacements
                done
            done
        # Read B2B Policies
        - mkdir -p cdc/b2b/policies
        - |
          curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              -d filter%5BownerId%5D=$b2bAuthzId \
              https://api.us1.b2b-gigya.com/policy-mgmt/policy/list |
            sed -e "$(replace_values)" | jq '.data' > "cdc/b2b/policies/list.json"
        - |
          jq -rc '.[] | .id, .name' "cdc/b2b/policies/list.json" |
            while IFS=$ read -r id; read -r name; do
              mkdir -p "cdc/b2b/policies/$name"
              curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  https://api.us1.b2b-gigya.com/policy-mgmt/policy/$id/asset-types |
                sed -e "$(replace_values)" | jq '.data' > "cdc/b2b/policies/$name/asset.types.json"              
              curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  https://api.us1.b2b-gigya.com/policy-mgmt/policy/$id/$b2bPartnersId/availability |
                sed -e "$(replace_values)" | jq '.data' > "cdc/b2b/policies/$name/availability.json"              
              curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  https://api.us1.b2b-gigya.com/policy-mgmt/policy/$id/dynamic-group/search |
                sed -e "$(replace_values)" | jq '.data' > "cdc/b2b/policies/$name/automated.assignments.json"              
            done
        # Read B2B Applications
        - mkdir -p cdc/b2b/applications
        - |
          curl -Gs --fail-with-body \
              -H "Authorization: Bearer $b2bAccessToken" \
              -d filter%5BownerId%5D=$b2bAuthzId \
              https://api.us1.b2b-gigya.com/internal-assets/4.0/applications |
            sed -e "$(replace_values)" | jq '.data' > "cdc/b2b/applications/list.json"
        - |
          jq -rc '.[] | .id, .attributes.name[0]' "cdc/b2b/applications/list.json" |
            while IFS=$ read -r id; read -r name; do
              mkdir -p "cdc/b2b/applications/$name"
              curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  https://api.us1.b2b-gigya.com/internal-assets/scopes/v3/$id |
                jq '.data' > "cdc/b2b/applications/$name/scopes.json"
              echo "{\"e\":\"$BITBUCKET_BRANCH\",\"n\":\"$name-b2b-app-client-id\",\"r\":\"$(jq -rc '.[0].clientId' "cdc/b2b/applications/$name/scopes.json")\"}" >> cdc/replacements
              curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  https://api.us1.b2b-gigya.com/env-mgmt/environment/$b2bEnvironmentId/federation/sp-config/$(jq -rc '.[0].clientId' "cdc/b2b/applications/$name/scopes.json") |
                sed -e "$(replace_values)" | jq '.data' > "cdc/b2b/applications/$name/federation.json"              
              sed -i -e "$(replace_values)" "cdc/b2b/applications/$name/scopes.json"
              curl -Gs --fail-with-body \
                  -H "Authorization: Bearer $b2bAccessToken" \
                  https://api.us1.b2b-gigya.com/internal-assets/asset-type/v3/application/$id |
                sed -e "$(replace_values)" | jq '.data' > "cdc/b2b/applications/$name/asset.types.json"              
            done
        # Read Schemas  
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site/schema"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d include=profileSchema,dataSchema,subscriptionsSchema,internalSchema \
                -d httpStatusCodes=true \
                https://accounts.$cdcDC/accounts.getSchema |
              jq -rc 'del('"$commonProperties"') | to_entries[] | .key, .value' |
                while IFS=$ read -r key; read -r value; do
                  echo "$value" | jq '.' > "cdc/$site/schema/$key.json"
                done
          done
        # Read Consent Statements  
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site/schema"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d httpStatusCodes=true \
                https://accounts.$cdcDC/accounts.getConsentsStatements |
              jq '.preferences' > "cdc/$site/consent.statements.json"
          done
        # Read Policies
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site/policies"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d httpStatusCodes=true \
                https://accounts.$cdcDC/accounts.getPolicies |
              jq -rc 'del('"$commonProperties"') | to_entries[] | .key, .value' |
              sed -e "$(replace_values)" | while IFS=$ read -r key; read -r value; do
                echo "$value" | jq '.' > "cdc/$site/policies/$key.json"
              done
          done
        # Read ScreenSets
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d include=metadata,screenSetID,html,css,javascript,translations \
                -d httpStatusCodes=true \
                https://accounts.$cdcDC/accounts.getScreenSets |
              jq '.screenSets' > "cdc/$site/screenSets.json"
          done
        # Read RBA Policy
        - apikey="${aapikey[0]}"
        - |
          curl -s --fail-with-body \
              -d apiKey=$apikey \
              --data-urlencode userKey=$cdcAppKey \
              --data-urlencode secret=$cdcAppSecret \
              -d httpStatusCodes=true \
              https://accounts.$cdcDC/accounts.rba.getPolicy |
            jq '.policy' > "cdc/rba.policy.json"
        # Read Extensions
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d httpStatusCodes=true \
                https://accounts.$cdcDC/accounts.extensions.list |
              jq '.result' > "cdc/$site/extensions.json"
          done
        # Read IDX Variables
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site/dataflows"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d scope=all \
                -d httpStatusCodes=true \
                https://idx.$cdcDC/idx.getGlobalVariables |
              jq '.data' |
              sed -e "$(replace_values)" > "cdc/$site/dataflows/globalVariables.json"
          done        
        # Read IDX Dataflows
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site/dataflows"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d query='select * from dataflow' \
                -d httpStatusCodes=true \
                https://idx.$cdcDC/idx.search |
              jq '.result // [] | map(del(.lastRuntime))' > "cdc/$site/dataflows/dataflows.json"
          done
        # Read IDX Scheduling
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site/dataflows"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d query='select * from scheduling' \
                -d httpStatusCodes=true \
                https://idx.$cdcDC/idx.search |              
              jq '.result // [] | map(del(.jobId, .nextJobStartTime))' | 
              sed -e "$(replace_values)" > "cdc/$site/dataflows/scheduling.json"
          done
        # Read Communication Channels
        - apikey="${aapikey[0]}"
        - |
          curl -s --fail-with-body \
              -d apiKey=$apikey \
              --data-urlencode userKey=$cdcAppKey \
              --data-urlencode secret=$cdcAppSecret \
              -d httpStatusCodes=true \
              https://accounts.$cdcDC/accounts.communication.getChannels |
            jq '.Channels' > "cdc/communication.channels.json"
        # Read Communication Topic Settings
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site/communication"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d httpStatusCodes=true \
                https://accounts.$cdcDC/accounts.communication.getTopicSettings |
              jq '.CommunicationSettings' > "cdc/$site/communication/topicSettings.json"
          done
        # Read SAML IdP Configuration
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site/federation"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d httpStatusCodes=true \
                https://fidm.$cdcDC/fidm.saml.idp.getConfig |
              jq '.config' |
              sed -e "$(replace_values)" > "cdc/$site/federation/samlIdPConfiguration.json"
          done
        # Read SAML SPs
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site/federation"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d httpStatusCodes=true \
                https://fidm.$cdcDC/fidm.saml.idp.getRegisteredSPs |
              jq '.configs' |
              sed -e "$(replace_values)" > "cdc/$site/federation/samlSPs.json"
          done
        # Read SAML IdPs
        - |
          for i in "${!asite[@]}"; do 
            site="${asite[$i]}"
            apikey="${aapikey[$i]}"
            mkdir -p "cdc/$site/federation"
            curl -s --fail-with-body \
                -d apiKey=$apikey \
                --data-urlencode userKey=$cdcAppKey \
                --data-urlencode secret=$cdcAppSecret \
                -d httpStatusCodes=true \
                https://fidm.$cdcDC/fidm.saml.getRegisteredIdPs |
              jq '.configs' |
              sed -e "$(replace_values)" > "cdc/$site/federation/samlIdPs.json"
          done
        # Commit Changes
        - mv cdc/replacements.bak cdc/replacements
        - |
          if [[ `git status --porcelain` ]]; then
            git config --global user.email 'refresh@build.pipeline'
            git config --global user.name 'Refresh Pipeline'
            git add --all
            git commit -m 'Refresh Pipeline [skip ci]'
            git push origin HEAD:$BITBUCKET_BRANCH
          fi
